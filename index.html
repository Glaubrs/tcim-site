<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TCIMbot - Viés de Mercado</title>
  <link rel="icon" type="image/png" href="favicon.png">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Streamlit Dark Theme Palette */
      --bg-body: #0E1117;       
      --bg-card: #262730;       
      --bg-hover: #31333F;
      
      --text-primary: #FAFAFA;  
      --text-secondary: #808495; 
      --text-muted: #616572;
      
      --border-color: #41444C;  
      
      /* Cores Funcionais */
      --color-buy: #09AB3B;     
      --color-buy-bg: rgba(9, 171, 59, 0.1);
      --color-sell: #FF4B4B;    
      --color-sell-bg: rgba(255, 75, 75, 0.1);
      --color-flat: #808495;
      --color-flat-bg: rgba(128, 132, 149, 0.1);
      --color-warn: #FFBD45;    
      --color-wait: #41444C; /* Cor para Aguarde */

      /* Fontes */
      --font-body: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'Source Code Pro', monospace;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-body);
      color: var(--text-primary);
      font-family: var(--font-body);
      -webkit-font-smoothing: antialiased;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 3rem 2rem;
    }

    /* --- Header Ajustado para Logo --- */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center; /* Centraliza verticalmente */
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1.5rem;
    }

    .branding {
      display: flex;
      align-items: center;
      gap: 1.5rem; /* Espaço entre logo e texto */
    }

    .logo-img {
      height: 60px; /* Ajuste a altura conforme necessário */
      width: auto;
      object-fit: contain;
      border-radius: 8px; /* Opcional: bordas arredondadas no logo */
    }

    .title-group h1 {
      margin: 0;
      font-size: 2.25rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }

    .title-group .sub {
      margin-top: 0.5rem;
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 400;
    }

    .header-info {
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .meta-info {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .dash-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background-color: transparent;
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    .dash-button:hover {
      border-color: var(--color-sell);
      color: var(--color-sell);
      background-color: rgba(255, 75, 75, 0.05);
    }

    /* --- Stats Bar --- */
    #stats { margin-bottom: 2rem; }
    .stats-grid { display: flex; gap: 2rem; flex-wrap: wrap; }
    .stat-item { display: flex; flex-direction: column; min-width: 120px; }
    .stat-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 400; }
    .stat-value { font-family: var(--font-body); font-size: 32px; font-weight: 700; color: var(--text-primary); }
    .stat-value.highlight { color: var(--color-buy); }

    /* --- Grid & Cards --- */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
    }

    .card {
      background-color: var(--bg-card);
      border-radius: 0.5rem;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .card-header {
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .session-name { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
    .version-tag { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; display: block; }

    /* Timer */
    .timer-container {
      background: var(--bg-body);
      border-radius: 0.25rem;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border-color);
    }

    .timer-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 0.25rem; letter-spacing: 0.5px; }
    .timer { font-family: var(--font-mono); font-size: 2rem; font-weight: 600; color: var(--text-primary); }

    /* Versions List */
    .version-list { display: flex; flex-direction: column; gap: 1rem; }
    .version-card { background-color: transparent; border: 1px solid var(--border-color); border-radius: 0.25rem; padding: 1rem; }

    .version-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .version-label { font-weight: 600; color: var(--text-primary); font-size: 1rem; }
    .version-acc { font-size: 0.85rem; color: var(--text-secondary); }

    .version-badge {
      display: inline-block; padding: 0.35rem 0.7rem; border-radius: 0.3rem;
      font-size: 1rem; font-weight: 700; text-transform: uppercase; margin-left: auto;
      letter-spacing: 0.5px;
    }
    .badge-up { background: var(--color-buy-bg); color: var(--color-buy); }
    .badge-down { background: var(--color-sell-bg); color: var(--color-sell); }
    .badge-flat { background: var(--color-flat-bg); color: var(--color-flat); }
    .badge-wait { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border-color); }

    .version-body { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; }

    .version-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 12px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .v-stat-item { display: flex; flex-direction: column; align-items: flex-start; }
    .v-stat-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; margin-bottom: 4px; text-transform: uppercase; }
    .v-stat-value { font-family: var(--font-mono); font-size: 0.9rem; font-weight: 600; color: var(--text-primary); line-height: 1.3; word-break: break-word; }

    .highlight-risk { color: var(--text-primary); border-left: 2px solid var(--color-warn); padding-left: 6px; }

    .hit-indicator { font-weight: 600; margin-top: 0.75rem; display: block; padding-top: 0.5rem; border-top: 1px dashed var(--border-color); }
    .hit-success { color: var(--color-buy); }
    .hit-fail { color: var(--color-sell); }

    .version-alerts { color: var(--color-warn); font-size: 0.85rem; margin-top: 0.5rem; background: rgba(234, 179, 8, 0.1); padding: 0.5rem; border-radius: 4px; }
    .version-alerts ul { margin: 0; padding-left: 1.2rem; }

    .waiting-msg { text-align: center; color: var(--text-muted); padding: 1rem; font-style: italic; }

    .error { background: var(--color-sell-bg); border: 1px solid var(--color-sell); color: var(--color-sell); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }

    @media (max-width: 600px) {
      .app-container { padding: 1.5rem 1rem; }
      header { flex-direction: column; gap: 1rem; align-items: flex-start; }
      .branding { width: 100%; justify-content: flex-start; }
      .header-info { text-align: left; align-items: flex-start; width: 100%; }
      .dash-button { width: 100%; }
      .stats-grid { gap: 1.5rem; }
    }
  </style>
</head>
<body>

  <div class="app-container">
    <header>
      <div class="branding">
        <img src="logo_horizontal.png" alt="TCIM Logo" class="logo-img">
        <div class="title-group">
          <h1>TCIM</h1>
          <div class="sub">Monitoramento de Viés</div>
        </div>
      </div>

      <div class="header-info">
        <a class="dash-button" href="https://tcim-dashboard.streamlit.app/" target="_blank" rel="noopener">
          Abrir Dashboard
        </a>
        <div class="meta-info" id="updatedAt">Aguardando...</div>
      </div>
    </header>

    <div id="stats">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">Acurácia Global</div>
          <div class="stat-value highlight" id="accuracyOverall">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Total de Sinais</div>
          <div class="stat-value" id="statsTotal">--</div>
        </div>
        <div class="stat-item" style="flex-grow: 1;">
           <div class="stat-label">Por Região</div>
           <div class="stat-value" id="statsByRegion" style="font-size: 1.25rem; font-weight: 600;">--</div>
        </div>
      </div>
    </div>

    <div id="error" class="error" style="display:none;"></div>
    
    <div class="grid" id="cards">
      </div>
  </div>

  <script>
    // Offset em minutos: quanto tempo antes da abertura mostrar os dados
    const sessions = [
      { id: "Asia", name: "Sessão Asiática - Sinal às 20:31 ", open: "00:00", close: "03:00", offset: 30 },
      { id: "Europe", name: "Sessão Europeia - Sinal às 03:46", open: "07:00", close: "10:00", offset: 15 },
      { id: "America", name: "Sessão Americana - Sinal às 10:16", open: "13:30", close: "16:30", offset: 15 },
    ];
    const API_URL = "latest_bias.json";
    const STATS_URL = "backtest_stats.json";

    let biasData = []; 
    let statsData = null;

    const cardsEl = document.getElementById("cards");
    const updatedEl = document.getElementById("updatedAt");
    const errorEl = document.getElementById("error");
    const statsBox = document.getElementById("stats");
    const statsTotalEl = document.getElementById("statsTotal");
    const statsByRegionEl = document.getElementById("statsByRegion");
    const accuracyOverallEl = document.getElementById("accuracyOverall");

    function parseUtcToday(hhmm) {
      const [h, m] = hhmm.split(":").map(Number);
      const now = new Date();
      return Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), h, m, 0);
    }

    function nextWindow(openUtc, closeUtc) {
      const now = Date.now();
      if (now < openUtc) return { status: "closed", nextOpen: openUtc, nextClose: closeUtc };
      if (now >= openUtc && now < closeUtc) return { status: "open", nextOpen: openUtc, nextClose: closeUtc };
      const oneDay = 24 * 3600 * 1000;
      return { status: "closed", nextOpen: openUtc + oneDay, nextClose: closeUtc + oneDay };
    }

    function fmt(ms) {
      const s = Math.max(0, Math.floor(ms / 1000));
      const h = String(Math.floor(s / 3600)).padStart(2, "0");
      const m = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
      const sec = String(s % 60).padStart(2, "0");
      return `${h}:${m}:${sec}`;
    }

    function formatRefTime(refStr) {
      if (!refStr) return "";
      const d = new Date(refStr);
      if (Number.isNaN(d.getTime())) return "";
      const date = d.toLocaleDateString("pt-BR");
      const time = d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
      return `${date} ${time}`;
    }

    function stripGapText(text) {
      if (!text) return "";
      return text
        .split(/<br>|\\n|;/)
        .map(t => t.trim())
        .filter(t => t && !/gap|ffill/i.test(t))
        .join("<br>");
    }

    function filterGapAlerts(list) {
      if (!Array.isArray(list)) return [];
      return list.filter(item => !/gap|ffill/i.test(item));
    }

    function render() {
      const now = Date.now();
      cardsEl.innerHTML = sessions.map(sess => {
        const openUtc = parseUtcToday(sess.open);
        const closeUtc = parseUtcToday(sess.close);
        const window = nextWindow(openUtc, closeUtc);
        
        const isOpen = window.status === "open" && now < window.nextClose;
        const target = isOpen ? window.nextClose : window.nextOpen;
        const countdown = fmt(target - now);
        const label = isOpen ? "Fecha em" : "Abre em";

        // LÓGICA DE EXIBIÇÃO:
        // Mostra dados SE (Está Aberto) OU (Falta menos que o Offset para abrir)
        const offsetMs = (sess.offset || 0) * 60 * 1000;
        const timeToOpen = window.nextOpen - now;
        const isPreMarket = !isOpen && timeToOpen <= offsetMs;
        
        const showData = isOpen || isPreMarket;

        const regionData = biasData.find(r => r.region === sess.id) || {};
        const versions = regionData.versions || [];
        const bestVersion = regionData.best_version?.version;
        const bestAcc = regionData.best_version?.accuracy;

        const versionCards = (versions || []).map(v => {
          // Se showData for false, forçamos o AGUARDE e limpamos o conteúdo
          let vbias = (v.vies || "AGUARDE").toUpperCase();
          let badge = vbias === "COMPRA" ? "badge-up" : vbias === "VENDA" ? "badge-down" : "badge-flat";
          
          let contentHtml = "";

          if (showData) {
              // RENDERIZAÇÃO NORMAL (DADOS VISÍVEIS)
              const accVal = (typeof v.accuracy === "number")
                ? v.accuracy
                : (bestVersion && v.version === bestVersion && typeof bestAcc === "number" ? bestAcc : null);
              const vAcc = (typeof accVal === "number") ? `${(accVal * 100).toFixed(0)}%` : "--";
              const vScore = (typeof v.score === "number") ? `Score: ${v.score.toFixed(1)}` : "";
              
              const sym = (v.symbol_results && v.symbol_results[0]) || {};
              const refLabel = formatRefTime(sym.ref_time);
              const refText = refLabel ? ` em ${refLabel}` : "";
              let vHit = `<div class="hit-indicator" style="color:var(--text-muted)">- Último sinal gerado${refText}: Pendente</div>`;
              if(v.hit === true) vHit = `<div class="hit-indicator hit-success">✔ Último sinal gerado${refText}: Win</div>`;
              if(v.hit === false) vHit = `<div class="hit-indicator hit-fail">✖ Último sinal gerado${refText}: Loss</div>`;

              const blocos = sym.blocos || {};
              const tend = (blocos.tendencia && blocos.tendencia.status) ? blocos.tendencia.status : "-";
              const ctx = (blocos.contexto && blocos.contexto.status) ? blocos.contexto.status : "-";
              const imp = (blocos.impulso && blocos.impulso.status) ? blocos.impulso.status : "-";
              const mit = (blocos.mitigacao && blocos.mitigacao.status) ? blocos.mitigacao.status : "-";
              
              const alerts = filterGapAlerts(Array.isArray(sym.alertas) ? sym.alertas : []);
              const alertsHtml = alerts.length
                ? `<div class="version-alerts">⚠ Alertas:<ul>${alerts.slice(0,3).map(a => `<li>${a}</li>`).join("")}</ul></div>`
                : "";
              
              const mitClass = mit.toLowerCase().includes('risco') || mit.toLowerCase().includes('alerta') 
                      ? 'v-stat-value highlight-risk' 
                      : 'v-stat-value';

              contentHtml = `
                <div class="version-header">
                    <div>
                      <span class="version-label">v${v.version || "--"}</span>
                      <span class="version-acc" style="margin-left:8px">Acc: ${vAcc}</span>
                      <span class="version-acc" style="margin-left:8px">${vScore}</span>
                    </div>
                    <div class="version-badge ${badge}">${vbias}</div>
                </div>
                <div class="version-body">
                    <div class="version-stats-grid">
                       <div class="v-stat-item"><span class="v-stat-label">Tendência</span><span class="v-stat-value">${tend}</span></div>
                       <div class="v-stat-item"><span class="v-stat-label">Contexto</span><span class="v-stat-value">${ctx}</span></div>
                       <div class="v-stat-item"><span class="v-stat-label">Impulso</span><span class="v-stat-value">${imp}</span></div>
                       <div class="v-stat-item"><span class="v-stat-label">Mitigação</span><span class="${mitClass}">${mit}</span></div>
                    </div>
                    ${alertsHtml}
                    ${vHit}
                </div>
              `;
          } else {
              // MODO AGUARDE (DADOS OCULTOS)
              badge = "badge-wait";
              vbias = "AGUARDE";
              contentHtml = `
                <div class="version-header">
                    <div>
                      <span class="version-label">v${v.version || "--"}</span>
                    </div>
                    <div class="version-badge ${badge}">${vbias}</div>
                </div>
                <div class="version-body">
                   <div class="waiting-msg">Análise disponível em breve...</div>
                </div>
              `;
          }

          return `<div class="version-card">${contentHtml}</div>`;

        }).join("") || '<div class="version-body" style="padding:1rem; text-align:center;">Sem versões disponíveis.</div>';

        return `
          <div class="card">
            <div class="card-header">
              <div>
                <div class="session-name">${sess.name}</div>
                <span class="version-tag">${versions.length || 0} versões ativas</span>
              </div>
            </div>
            
            <div class="timer-container">
              <div class="timer-label">${label}</div>
              <div class="timer">${countdown}</div>
            </div>
            
            <div class="version-list">
              ${versionCards}
            </div>
          </div>
        `;
      }).join("");
    }

    function renderStats() {
      if (!statsData) {
        statsBox.style.display = "none";
        return;
      }
      statsBox.style.display = "block";
      
      const acc = typeof statsData.accuracy === "number" ? `${(statsData.accuracy * 100).toFixed(1)}%` : "--";
      accuracyOverallEl.textContent = acc;
      statsTotalEl.textContent = statsData.total || "--";

      const regions = statsData.by_region || {};
      const regionHtml = Object.entries(regions).map(([reg, info]) => {
        const accReg = typeof info.accuracy === "number" ? `${(info.accuracy * 100).toFixed(0)}%` : "--";
        const nameMap = { "Asia": "Ásia", "Europe": "Europa", "America": "EUA" };
        const name = nameMap[reg] || reg;
        
        const color = (info.accuracy >= 0.55) ? 'var(--color-buy)' : (info.accuracy < 0.45) ? 'var(--color-sell)' : 'var(--text-muted)';
        
        return `<span style="margin-right: 16px; white-space: nowrap; font-size: 0.9rem; font-family:var(--font-mono); color: var(--text-secondary);">${name} <strong style="color:${color}; font-size:1.1rem; margin-left:4px;">${accReg}</strong></span>`;
      }).join("");
      
      statsByRegionEl.innerHTML = regionHtml;
    }

    async function fetchData() {
      try {
        const [biasRes, statsRes] = await Promise.all([
          fetch(API_URL, { cache: "no-store" }),
          fetch(STATS_URL, { cache: "no-store" }),
        ]);
        
        if (!biasRes.ok) throw new Error(`API Bias: ${biasRes.status}`);
        
        const biasPayload = await biasRes.json();
        let statsPayload = null;
        if(statsRes.ok) statsPayload = await statsRes.json();

        biasData = biasPayload.regions || [];
        statsData = statsPayload;

        const dateObj = new Date(biasPayload.updated_at);
        updatedEl.textContent = `Atualizado: ${dateObj.toLocaleTimeString()} (${dateObj.toLocaleDateString()})`;
        
        errorEl.style.display = "none";
        renderStats();
        // Força renderização imediatamente após carregar dados
        render();
      } catch (err) {
        console.error(err);
        updatedEl.textContent = "Offline / Reconectando...";
      }
    }

    fetchData();
    // Renderiza a cada 1s para o timer e a lógica de exibição
    setInterval(render, 1000);
    setInterval(fetchData, 60000);
  </script>
</body>
</html>
