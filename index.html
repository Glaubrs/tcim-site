<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TCIM - Vi√©s de Mercado</title>
  <link rel="icon" type="image/png" href="favicon.png">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Streamlit Dark Theme Palette */
      --bg-body: #0E1117;       
      --bg-card: #262730;       
      --bg-hover: #31333F;
      
      --text-primary: #FAFAFA;  
      --text-secondary: #808495; 
      --text-muted: #616572;
      
      --border-color: #41444C;  
      
      /* Cores Funcionais */
      --color-buy: #09AB3B;     
      --color-buy-bg: rgba(9, 171, 59, 0.1);
      --color-sell: #FF4B4B;    
      --color-sell-bg: rgba(255, 75, 75, 0.1);
      --color-flat: #808495;
      --color-flat-bg: rgba(128, 132, 149, 0.1);
      --color-warn: #FFBD45;    
      --color-wait: #41444C; 

      /* Fontes */
      --font-body: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'Source Code Pro', monospace;
      --font-digital: 'Courier New', monospace;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-body);
      color: var(--text-primary);
      font-family: var(--font-body);
      -webkit-font-smoothing: antialiased;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 3rem 2rem;
    }

    /* --- Manuten√ß√£o --- */
    #maintenance-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      text-align: center;
      padding: 2rem;
    }
    .maintenance-icon { font-size: 5rem; margin-bottom: 1.5rem; }
    #maintenance-screen h2 { color: var(--color-warn); font-size: 2.5rem; margin-bottom: 1rem; }
    #maintenance-screen p { color: var(--text-secondary); font-size: 1.2rem; max-width: 600px; line-height: 1.6; }

    /* --- Header --- */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1.5rem;
    }

    .branding { display: flex; align-items: center; gap: 1.5rem; }
    .logo-img { height: 90px; width: auto; object-fit: contain; border-radius: 8px; }

    .title-group h1 { margin: 0; font-size: 2.25rem; font-weight: 700; color: var(--text-primary); line-height: 1; }
    .title-group .sub { margin-top: 0.5rem; color: var(--text-secondary); font-size: 1rem; font-weight: 400; }

    .header-info { text-align: right; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; }
    .meta-info { font-size: 0.8rem; color: var(--text-muted); font-family: var(--font-mono); }

    .dash-button {
      display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem;
      border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.2); background-color: transparent;
      color: var(--text-primary); text-decoration: none; font-weight: 600; font-size: 14px; transition: all 0.2s;
    }
    .dash-button:hover { border-color: var(--color-sell); color: var(--color-sell); background-color: rgba(255, 75, 75, 0.05); }

    /* --- Stats Bar Layout --- */
    #stats { margin-bottom: 2rem; }
    
    .stats-grid { 
        display: flex; 
        gap: 2rem; 
        flex-wrap: wrap; 
        align-items: center; 
    }
    
    .stat-item { 
        display: flex; flex-direction: column; min-width: 120px; 
    }
    .stat-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 400; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-family: var(--font-body); font-size: 32px; font-weight: 700; color: var(--text-primary); }
    .stat-value.highlight { color: var(--color-buy); }


    /* --- SAFETY SIGN --- */
    .safety-sign {
      background: linear-gradient(180deg, #262730 0%, #1c1e24 100%);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      min-width: 180px;
      width: auto;
      flex-grow: 0;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      margin-left: auto;
    }

    .sign-header {
      padding: 6px 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.7rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; justify-content: center; align-items: center; gap: 6px;
    }

    .sign-body { padding: 10px 15px; }
    .sign-pre { color: var(--text-secondary); font-size: 0.65rem; letter-spacing: 1px; margin-bottom: 2px; }
    
    .sign-number {
      font-family: var(--font-digital);
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1;
      margin: 4px 0;
      text-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
    .sign-pos { font-weight: 600; font-size: 0.8rem; color: var(--text-primary); }

    .safety-sign.safe { border-color: var(--color-buy); box-shadow: 0 0 10px rgba(9, 171, 59, 0.1); }
    .safety-sign.safe .sign-header { background-color: rgba(9, 171, 59, 0.15); color: var(--color-buy); border-bottom-color: var(--color-buy); }
    .safety-sign.safe .sign-number { color: var(--color-buy); text-shadow: 0 0 15px rgba(9, 171, 59, 0.5); }
    .safety-sign.safe .sign-pos { color: var(--text-primary); }

    .safety-sign.danger { border-color: var(--color-sell); box-shadow: 0 0 10px rgba(255, 75, 75, 0.1); }
    .safety-sign.danger .sign-header {
      background: repeating-linear-gradient(45deg, #2d1b1b, #2d1b1b 10px, var(--color-sell) 10px, var(--color-sell) 20px);
      color: white; text-shadow: 0 1px 2px black; border-bottom-color: var(--color-sell);
    }
    .safety-sign.danger .sign-number { color: var(--color-sell); text-shadow: 0 0 15px rgba(255, 75, 75, 0.5); }
    .safety-sign.danger .sign-pos { color: var(--color-sell); }


    /* --- Grid & Cards --- */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
    
    .card {
      background-color: var(--bg-card); border-radius: 0.5rem; padding: 1.5rem;
      display: flex; flex-direction: column; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-2px); }

    .card-header { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: flex-start; }
    .session-name { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
    .version-tag { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; display: block; }

    .timer-container {
      background: var(--bg-body); border-radius: 0.25rem; padding: 1rem; text-align: center;
      margin-bottom: 1.5rem; border: 1px solid var(--border-color);
    }
    .timer-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 0.25rem; letter-spacing: 0.5px; }
    .timer { font-family: var(--font-mono); font-size: 2rem; font-weight: 600; color: var(--text-primary); }

    .version-list { display: flex; flex-direction: column; gap: 1rem; }
    .version-card { background-color: transparent; border: 1px solid var(--border-color); border-radius: 0.25rem; padding: 1rem; }
    .version-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .version-label { font-weight: 600; color: var(--text-primary); font-size: 1rem; }
    .version-acc { font-size: 0.85rem; color: var(--text-secondary); }

    .version-badge {
      display: inline-block; padding: 0.35rem 0.7rem; border-radius: 0.3rem;
      font-size: 1rem; font-weight: 700; text-transform: uppercase; margin-left: auto; letter-spacing: 0.5px;
    }
    .badge-up { background: var(--color-buy-bg); color: var(--color-buy); }
    .badge-down { background: var(--color-sell-bg); color: var(--color-sell); }
    .badge-flat { background: var(--color-flat-bg); color: var(--color-flat); }
    .badge-wait { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border-color); }

    .version-body { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; }
    .version-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    
    .v-stat-item { display: flex; flex-direction: column; align-items: flex-start; }
    .v-stat-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; margin-bottom: 4px; text-transform: uppercase; }
    .v-stat-value { font-family: var(--font-mono); font-size: 0.9rem; font-weight: 600; color: var(--text-primary); line-height: 1.3; word-break: break-word; }
    .highlight-risk { color: var(--text-primary); border-left: 2px solid var(--color-warn); padding-left: 6px; }

    .hit-indicator { font-weight: 600; margin-top: 0.75rem; display: block; padding-top: 0.5rem; border-top: 1px dashed var(--border-color); }
    .hit-success { color: var(--color-buy); }
    .hit-fail { color: var(--color-sell); }
    
    .version-alerts { color: var(--color-warn); font-size: 0.85rem; margin-top: 0.5rem; background: rgba(234, 179, 8, 0.1); padding: 0.5rem; border-radius: 4px; }
    .version-alerts ul { margin: 0; padding-left: 1.2rem; }
    .waiting-msg { text-align: center; color: var(--text-muted); padding: 1rem; font-style: italic; }
    .error { background: var(--color-sell-bg); border: 1px solid var(--color-sell); color: var(--color-sell); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }

    @media (max-width: 600px) {
      .app-container { padding: 1.5rem 1rem; }
      header { flex-direction: column; gap: 1rem; align-items: flex-start; }
      .branding { width: 100%; justify-content: flex-start; }
      .header-info { text-align: left; align-items: flex-start; width: 100%; }
      .dash-button { width: 100%; }
      .stats-grid { gap: 2rem; flex-direction: column; align-items: flex-start; }
      .stat-item { width: 100%; }
      .safety-sign { width: 100%; margin-left: 0; }
    }
  </style>
</head>
<body>

  <div id="maintenance-screen">
    <div class="maintenance-icon">üöß</div>
    <h2>Em Manuten√ß√£o</h2>
    <p>Estamos realizando ajustes e o TCIM estar√° dispon√≠vel novamente em breve. Agradecemos sua compreens√£o</p>
  </div>

  <div id="main-content">
    <div class="app-container">
      <header>
        <div class="branding">
          <img src="logo.png" alt="TCIM Logo" class="logo-img">
          <div class="title-group">
            <h1>TCIM</h1>
            <div class="sub">Monitoramento de Vi√©s</div>
          </div>
        </div>
        <div class="header-info">
          <a class="dash-button" href="https://tcim-dashboard.streamlit.app/" target="_blank" rel="noopener">
            Abrir Dashboard
          </a>
          <div class="meta-info" id="updatedAt">Aguardando...</div>
        </div>
      </header>

      <div id="stats">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">Acur√°cia Global</div>
            <div class="stat-value highlight" id="accuracyOverall">--</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">Total de Sinais</div>
            <div class="stat-value" id="statsTotal">--</div>
          </div>

          <div class="stat-item" style="flex-grow: 1;">
             <div class="stat-label">Por Regi√£o</div>
             <div class="stat-value" id="statsByRegion" style="font-size: 1.25rem; font-weight: 600;">--</div>
          </div>

          <div class="safety-sign safe" id="lossSign">
             <div class="sign-header">
               <span id="signHeaderIcon">‚ö°</span> 
               <span id="signHeaderText">Disciplina</span>
             </div>
             <div class="sign-body">
               <div class="sign-pre" id="signPreText">ESTAMOS H√Å</div>
               <div class="sign-number" id="statsDaysNoLoss">--</div>
               <div class="sign-pos" id="signPosText">DIAS SEM LOSS</div>
             </div>
          </div>

        </div>
      </div>

      <div id="error" class="error" style="display:none;"></div>
      
      <div class="grid" id="cards"></div>
    </div>
  </div>

  <script>
    // FLAG DE MANUTEN√á√ÉO: Altere para true para travar o site
    const IS_MAINTENANCE = False

    // Elementos de controle de visibilidade
    const mainContent = document.getElementById("main-content");
    const maintenanceScreen = document.getElementById("maintenance-screen");

    function checkMaintenance() {
      if (IS_MAINTENANCE) {
        mainContent.style.display = "none";
        maintenanceScreen.style.display = "flex";
        return true;
      } else {
        mainContent.style.display = "block";
        maintenanceScreen.style.display = "none";
        return false;
      }
    }

    // S√≥ executa o resto se N√ÉO estiver em manuten√ß√£o
    if (!checkMaintenance()) {
      const sessions = [
        { id: "Asia", name: "Sess√£o Asi√°tica - Sinal √†s 20:31 ", open: "00:00", close: "03:00", offset: 28 },
        { id: "Europe", name: "Sess√£o Europeia - Sinal √†s 03:46", open: "07:00", close: "10:00", offset: 13 },
        { id: "America", name: "Sess√£o Americana - Sinal √†s 10:16", open: "13:30", close: "16:30", offset: 13 },
      ];
      const HOLIDAYS_BY_REGION = {
        America: ["2024-12-25", "2025-01-01", "2025-12-25"],
        Europe: ["2024-12-25", "2025-01-01", "2025-12-25"],
        Asia: ["2024-12-25", "2025-01-01", "2025-12-25"],
      };
      const API_URL = "latest_bias.json";
      const STATS_URL = "backtest_stats.json";

      let biasData = []; 
      let statsData = null;
      let biasUpdatedAt = null;

      const cardsEl = document.getElementById("cards");
      const updatedEl = document.getElementById("updatedAt");
      const errorEl = document.getElementById("error");
      const statsBox = document.getElementById("stats");
      const statsTotalEl = document.getElementById("statsTotal");
      const accuracyOverallEl = document.getElementById("accuracyOverall");
      const statsByRegionEl = document.getElementById("statsByRegion");

      const lossSignEl = document.getElementById("lossSign");
      const daysNoLossEl = document.getElementById("statsDaysNoLoss");
      const signHeaderTextEl = document.getElementById("signHeaderText");
      const signHeaderIconEl = document.getElementById("signHeaderIcon");
      const signPreTextEl = document.getElementById("signPreText");
      const signPosTextEl = document.getElementById("signPosText");

      function parseUtcToday(hhmm) {
        const [h, m] = hhmm.split(":").map(Number);
        const now = new Date();
        return Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), h, m, 0);
      }

      function isWeekend(ts) {
        const day = new Date(ts).getUTCDay();
        return day === 0 || day === 6;
      }

      function isHoliday(ts, regionId) {
        const d = new Date(ts);
        if (Number.isNaN(d.getTime())) return false;
        const yyyy = d.getUTCFullYear();
        const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
        const dd = String(d.getUTCDate()).padStart(2, "0");
        const keyFull = `${yyyy}-${mm}-${dd}`;
        const keyMD = `${mm}-${dd}`;
        const list = (HOLIDAYS_BY_REGION[regionId] || []);
        return list.some(item => item === keyFull || item.slice(5) === keyMD);
      }

      function rollToNextOpenDay(ts, regionId) {
        const oneDay = 24 * 3600 * 1000;
        let t = ts;
        while (isWeekend(t) || isHoliday(t, regionId)) t += oneDay;
        return t;
      }

      function nextWindow(openUtc, closeUtc, regionId) {
        const now = Date.now();
        const oneDay = 24 * 3600 * 1000;
        let openDay = rollToNextOpenDay(openUtc, regionId);
        let closeDay = closeUtc + (openDay - openUtc);
        if (now < openDay) return { status: "closed", nextOpen: openDay, nextClose: closeDay };
        if (now >= openDay && now < closeDay) return { status: "open", nextOpen: openDay, nextClose: closeDay };
        let nextOpen = rollToNextOpenDay(openDay + oneDay, regionId);
        let nextClose = closeDay + (nextOpen - openDay);
        return { status: "closed", nextOpen, nextClose };
      }

      function fmt(ms) {
        const s = Math.max(0, Math.floor(ms / 1000));
        const h = String(Math.floor(s / 3600)).padStart(2, "0");
        const m = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
        const sec = String(s % 60).padStart(2, "0");
        return `${h}:${m}:${sec}`;
      }

      function formatRefTime(refStr) {
        if (!refStr) return "";
        const d = new Date(refStr);
        if (Number.isNaN(d.getTime())) return "";
        return d.toLocaleDateString("pt-BR");
      }

      function filterGapAlerts(list) {
        if (!Array.isArray(list)) return [];
        return list.filter(item => !/gap|ffill/i.test(item));
      }

      function normalizeAlertText(text) {
        if (!text) return text;
        const trimmed = String(text).trim();
        if (/^Volatilidade excessiva detectada/i.test(trimmed)) {
          return "Volatilidade excessiva detectada";
        }
        if (/^Baixa volatilidade/i.test(trimmed)) {
          return "Baixa volatilidade";
        }
        if (/^EuropeSafety:/i.test(trimmed)) {
          return "EuropeSafety aplicado";
        }
        if (/^AmericaSoft:/i.test(trimmed)) {
          return "AmericaSoft aplicado";
        }
        if (/^AsiaSafety:/i.test(trimmed)) {
          return "AsiaSafety aplicado";
        }
        return trimmed;
      }

      function parseSessionStartUtc(str) {
        if (!str) return null;
        const m = str.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})/);
        if (!m) return null;
        const [, dd, mm, yyyy, hh, min] = m;
        return Date.UTC(Number(yyyy), Number(mm) - 1, Number(dd), Number(hh), Number(min));
      }

      function isSameLocalDate(a, b) {
        return a.getFullYear() === b.getFullYear()
          && a.getMonth() === b.getMonth()
          && a.getDate() === b.getDate();
      }

      function isDataReadyForSession(regionData, offsetMinutes) {
        const updated = regionData?.updated_at ? new Date(regionData.updated_at) : biasUpdatedAt;
        const sessionStartUtc = parseSessionStartUtc(regionData?.session_start);
        if (!updated || Number.isNaN(updated.getTime())) return false;
        if (!isSameLocalDate(updated, new Date())) return false;
        if (!sessionStartUtc) return true;
        const releaseTime = sessionStartUtc - (offsetMinutes || 0) * 60 * 1000;
        return updated.getTime() >= releaseTime;
      }

      function render() {
        const now = Date.now();
        const sessionsWithStatus = sessions.map(sess => {
          const openUtc = parseUtcToday(sess.open);
          const closeUtc = parseUtcToday(sess.close);
          const window = nextWindow(openUtc, closeUtc, sess.id);
          const isOpen = window.status === "open" && now < window.nextClose;
          const timeTarget = isOpen ? window.nextClose : window.nextOpen;
          return { ...sess, _window: window, _isOpen: isOpen, _timeTarget: timeTarget };
        });

        sessionsWithStatus.sort((a, b) => {
          if (a._isOpen && !b._isOpen) return -1;
          if (!a._isOpen && b._isOpen) return 1;
          return a._timeTarget - b._timeTarget;
        });

        cardsEl.innerHTML = sessionsWithStatus.map(sess => {
          const window = sess._window;
          const isOpen = sess._isOpen;
          const target = isOpen ? window.nextClose : window.nextOpen;
          const countdown = fmt(target - now);
          const label = isOpen ? "Fecha em" : "Abre em";
          const offsetMs = (sess.offset || 0) * 60 * 1000;
          const timeToOpen = window.nextOpen - now;
          const isPreMarket = !isOpen && timeToOpen <= offsetMs;
          const regionData = biasData.find(r => r.region === sess.id) || {};
          const dataReady = isDataReadyForSession(regionData, sess.offset || 0);
          const showData = (isOpen || isPreMarket) && dataReady;
          const versions = regionData.versions || [];
          const bestVersion = regionData.best_version?.version;
          const bestAcc = regionData.best_version?.accuracy;

          const versionCards = (versions || []).map(v => {
            let vbias = (v.vies || "AGUARDE").toUpperCase();
            let badge = vbias === "COMPRA" ? "badge-up" : vbias === "VENDA" ? "badge-down" : "badge-flat";
            let contentHtml = "";

            if (showData) {
                const accVal = (typeof v.accuracy === "number")
                  ? v.accuracy
                  : (bestVersion && v.version === bestVersion && typeof bestAcc === "number" ? bestAcc : null);
                const vAcc = (typeof accVal === "number") ? `${(accVal * 100).toFixed(0)}%` : "--";
                const vScore = (typeof v.score === "number") ? `Score: ${v.score.toFixed(1)}` : "";
                const sym = (v.symbol_results && v.symbol_results[0]) || {};
                const hitRef = v.hit_ref_time || sym.ref_time;
                const refLabel = formatRefTime(hitRef);
                const refText = refLabel ? ` em ${refLabel}` : "";
                let vHit = `<div class="hit-indicator" style="color:var(--text-muted)">- √öltimo sinal gerado${refText}: Pendente</div>`;
                if(v.hit === true) vHit = `<div class="hit-indicator hit-success">‚úî √öltimo sinal gerado${refText}: Win</div>`;
                if(v.hit === false) vHit = `<div class="hit-indicator hit-fail">‚úñ √öltimo sinal gerado${refText}: Loss</div>`;
                const blocos = sym.blocos || {};
                const tend = (blocos.tendencia && blocos.tendencia.status) ? blocos.tendencia.status : "-";
                const ctx = (blocos.contexto && blocos.contexto.status) ? blocos.contexto.status : "-";
                const imp = (blocos.impulso && blocos.impulso.status) ? blocos.impulso.status : "-";
                const mitInfo = blocos.mitigacao || {};
                const mitVals = mitInfo.valores || {};
                const mitBlocked = mitVals.mitigation_blocked === true;
                const mitScore = (typeof mitInfo.score === "number") ? mitInfo.score : 0;
                const alerts = filterGapAlerts(Array.isArray(sym.alertas) ? sym.alertas : []);
                const alertsDisplay = alerts.map(normalizeAlertText);
                const vetoFromAlerts = alertsDisplay.some(a => {
                  if (!a) return false;
                  const clean = String(a).trim();
                  if (/^(EuropeSafety|AmericaSoft|AsiaSafety):/i.test(clean)) return true;
                  if (/^(EuropeSafety aplicado|AmericaSoft aplicado|AsiaSafety aplicado)/i.test(clean)) return true;
                  return /veto|vetado|cancelado/i.test(clean);
                });
                let mit = "-";
                if (mitBlocked || vetoFromAlerts) mit = "Sinal Vetado";
                else if (mitScore < 0) mit = "Sinal Penalizado";
                else mit = "Sem penalidade";
                const mitClass = (mit === "Sinal Vetado" || mit === "Sinal Penalizado") ? 'v-stat-value highlight-risk' : 'v-stat-value';
                const alertsHtml = alertsDisplay.length ? `<div class="version-alerts">‚ö† Alertas:<ul>${alertsDisplay.slice(0,3).map(a => `<li>${a}</li>`).join("")}</ul></div>` : "";

                contentHtml = `
                  <div class="version-header">
                      <div><span class="version-label">v${v.version || "--"}</span><span class="version-acc" style="margin-left:8px">Acc: ${vAcc}</span><span class="version-acc" style="margin-left:8px">${vScore}</span></div>
                      <div class="version-badge ${badge}">${vbias}</div>
                  </div>
                  <div class="version-body">
                      <div class="version-stats-grid">
                         <div class="v-stat-item"><span class="v-stat-label">Tend√™ncia</span><span class="v-stat-value">${tend}</span></div>
                         <div class="v-stat-item"><span class="v-stat-label">Contexto</span><span class="v-stat-value">${ctx}</span></div>
                         <div class="v-stat-item"><span class="v-stat-label">Impulso</span><span class="v-stat-value">${imp}</span></div>
                         <div class="v-stat-item"><span class="v-stat-label">Mitiga√ß√£o</span><span class="${mitClass}">${mit}</span></div>
                      </div>
                      ${alertsHtml}
                      ${vHit}
                  </div>`;
            } else {
                badge = "badge-wait"; vbias = "AGUARDE";
                const waitText = dataReady ? "An√°lise dispon√≠vel em breve..." : "Aguardando atualiza√ß√£o...";
                contentHtml = `<div class="version-header"><div><span class="version-label">v${v.version || "--"}</span></div><div class="version-badge ${badge}">${vbias}</div></div><div class="version-body"><div class="waiting-msg">${waitText}</div></div>`;
            }
            return `<div class="version-card">${contentHtml}</div>`;
          }).join("") || '<div class="version-body" style="padding:1rem; text-align:center;">Sem vers√µes dispon√≠veis.</div>';

          return `<div class="card"><div class="card-header"><div><div class="session-name">${sess.name}</div><span class="version-tag">${versions.length || 0} vers√µes ativas</span></div></div><div class="timer-container"><div class="timer-label">${label}</div><div class="timer">${countdown}</div></div><div class="version-list">${versionCards}</div></div>`;
        }).join("");
      }

      function renderStats() {
        if (!statsData) { statsBox.style.display = "none"; return; }
        statsBox.style.display = "block";
        
        const acc = typeof statsData.accuracy === "number" ? `${(statsData.accuracy * 100).toFixed(1)}%` : "--";
        accuracyOverallEl.textContent = acc;
        statsTotalEl.textContent = statsData.total || "--";
        
        const daysNoLoss = statsData.days_without_loss;
        const daysVal = typeof daysNoLoss === "number" ? daysNoLoss : 0;
        daysNoLossEl.textContent = String(daysVal).padStart(2, '0');

        if (daysVal < 3) {
            lossSignEl.className = "safety-sign danger";
            signHeaderIconEl.textContent = "‚ö†";
            signHeaderTextEl.textContent = "RESET DE RISCO";
            if (daysVal === 0) {
                signPreTextEl.textContent = "O √öLTIMO LOSS FOI";
                signPosTextEl.textContent = "DIAS (HOJE)"; 
            } else {
                signPreTextEl.textContent = "O √öLTIMO LOSS FOI H√Å";
                signPosTextEl.textContent = (daysVal === 1) ? "DIA" : "DIAS";
            }
        } else {
            lossSignEl.className = "safety-sign safe";
            signHeaderIconEl.textContent = "‚ö°";
            signHeaderTextEl.textContent = "Disciplina";
            signPreTextEl.textContent = "ESTAMOS H√Å";
            signPosTextEl.textContent = "DIAS SEM LOSS";
        }

        const regions = statsData.by_region || {};
        const regionHtml = Object.entries(regions).map(([reg, info]) => {
          const accReg = typeof info.accuracy === "number" ? `${(info.accuracy * 100).toFixed(0)}%` : "--";
          const nameMap = { "Asia": "√Åsia", "Europe": "Europa", "America": "EUA" };
          const name = nameMap[reg] || reg;
          const color = (info.accuracy >= 0.55) ? 'var(--color-buy)' : (info.accuracy < 0.45) ? 'var(--color-sell)' : 'var(--text-muted)';
          return `<span style="margin-right: 16px; white-space: nowrap; font-size: 0.9rem; font-family:var(--font-mono); color: var(--text-secondary);">${name} <strong style="color:${color}; font-size:1.1rem; margin-left:4px;">${accReg}</strong></span>`;
        }).join("");
        statsByRegionEl.innerHTML = regionHtml;
      }

      async function fetchData() {
        try {
          const [biasRes, statsRes] = await Promise.all([ fetch(API_URL, { cache: "no-store" }), fetch(STATS_URL, { cache: "no-store" }), ]);
          if (!biasRes.ok) throw new Error(`API Bias: ${biasRes.status}`);
          const biasPayload = await biasRes.json();
          let statsPayload = null;
          if(statsRes.ok) statsPayload = await statsRes.json();
          biasData = biasPayload.regions || [];
          statsData = statsPayload;
          biasUpdatedAt = biasPayload.updated_at ? new Date(biasPayload.updated_at) : null;
          const dateObj = biasUpdatedAt && !Number.isNaN(biasUpdatedAt.getTime()) ? biasUpdatedAt : null;
          if (dateObj) {
            updatedEl.textContent = `Atualizado: ${dateObj.toLocaleTimeString()} (${dateObj.toLocaleDateString()})`;
          } else {
            updatedEl.textContent = "Atualizado: --";
          }
          errorEl.style.display = "none"; renderStats(); render();
        } catch (err) {
          console.error(err); updatedEl.textContent = "Offline / Reconectando...";
        }
      }

      fetchData();
      setInterval(render, 1000);
      setInterval(fetchData, 60000);
    }
  </script>
</body>
</html>
